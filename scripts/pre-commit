#!/bin/bash
# Pre-commit hook that runs forge fmt

# Get the root directory of the git repository
GIT_ROOT=$(git rev-parse --show-toplevel)

echo "Running forge fmt..."

# Run forge fmt
cd "$GIT_ROOT" && forge fmt

# Check if forge fmt made any changes
if [[ -n $(git diff --name-only) ]]; then
    echo "✨ forge fmt has formatted some files. Adding changes to commit..."
    
    # Get list of files that were staged before formatting
    STAGED_FILES=$(git diff --cached --name-only)
    
    # Add the formatted versions of staged files back to staging
    for file in $STAGED_FILES; do
        if [[ -f "$file" ]]; then
            git add "$file"
        fi
    done
    
    echo "✅ Formatted files have been added to your commit."
else
    echo "✅ All files are already properly formatted."
fi

# Run forge build to ensure compilation
echo "Running forge build..."
if ! forge build; then
    echo "❌ Build failed. Please fix compilation errors before committing."
    exit 1
fi

echo "✅ Pre-commit checks passed!"
exit 0